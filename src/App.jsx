// src/App.jsx
import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
import { BrowserRouter as Router, Routes, Route, useNavigate, useParams, Link } from 'react-router-dom';
import { Search, ArrowLeft, FileText } from 'lucide-react';


// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
const parseMarkdown = (markdown) => {
  return markdown
    .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mb-2">$1</h3>')
    .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mb-3">$1</h2>')
    .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mb-4">$1</h1>')
    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
    .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
    .replace(/^- (.*$)/gim, '<li class="ml-4 list-disc">$1</li>')
    .replace(/\n\n/g, '</p><p class="mb-2">')
    .replace(/^(?!<[h|l])/gm, '<p class="mb-2">')
    .replace(/<\/p><p class="mb-2">(<[h|l])/g, '$1');
};

const parseFrontmatter = (content) => {
  const frontmatterRegex = /^---\n([\s\S]*?)\n---\n([\s\S]*)$/;
  const match = content.match(frontmatterRegex);
  
  if (!match) return { metadata: {}, content };
  
  const frontmatter = match[1];
  const body = match[2];
  
  const metadata = {};
  frontmatter.split('\n').forEach(line => {
    const [key, ...values] = line.split(':');
    if (key && values.length) {
      metadata[key.trim()] = values.join(':').trim();
    }
  });
  
  return { metadata, content: body };
};

const extractBMCSections = (content) => {
  const sections = [
    'Key Partners',
    'Key Activities', 
    'Key Resources',
    'Value Propositions',
    'Customer Relationships',
    'Channels',
    'Customer Segments',
    'Cost Structure',
    'Revenue Streams'
  ];
  
  const bmcData = {};
  
  sections.forEach(section => {
    const regex = new RegExp(`## ${section}\\s*([\\s\\S]*?)(?=## |$)`, 'i');
    const match = content.match(regex);
    bmcData[section] = match ? match[1].trim() : '';
  });
  
  return bmcData;
};

// BMCÊó•Êú¨Ë™ûÂØæË®≥„Å®„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÊÉÖÂ†±
const BMC_TRANSLATIONS = {
  'Key Partners': {
    japanese: '‰∏ªË¶Å„Éë„Éº„Éà„Éä„Éº',
    description: '„Éì„Ç∏„Éç„Çπ„ÇíÊîØ„Åà„ÇãÈáçË¶Å„Å™„Éë„Éº„Éà„Éä„Éº‰ºÅÊ•≠„ÇÑÁµÑÁπî',
    examples: '„Çµ„Éó„É©„Ç§„É§„Éº„ÄÅË≤©Â£≤‰ª£ÁêÜÂ∫ó„ÄÅÊäÄË°ì„Éë„Éº„Éà„Éä„Éº„Å™„Å©'
  },
  'Key Activities': {
    japanese: '‰∏ªË¶ÅÊ¥ªÂãï',
    description: '„Éì„Ç∏„Éç„Çπ„ÇíÊ©üËÉΩ„Åï„Åõ„Çã„Åü„ÇÅ„Å´ÂøÖË¶Å„Å™ÈáçË¶Å„Å™Ê¥ªÂãï',
    examples: 'Ë£ΩÈÄ†„ÄÅ„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞„ÄÅÁ†îÁ©∂ÈñãÁô∫„ÄÅË≤©Â£≤„Å™„Å©'
  },
  'Key Resources': {
    japanese: '‰∏ªË¶Å„É™„ÇΩ„Éº„Çπ',
    description: '„Éì„Ç∏„Éç„Çπ„Å´‰∏çÂèØÊ¨†„Å™ÈáçË¶Å„Å™Ë≥áÊ∫ê',
    examples: '‰∫∫Êùê„ÄÅÊäÄË°ì„ÄÅË®≠ÂÇô„ÄÅ„Éñ„É©„É≥„Éâ„ÄÅË≥áÈáë„Å™„Å©'
  },
  'Value Propositions': {
    japanese: '‰æ°ÂÄ§ÊèêÊ°à',
    description: 'È°ßÂÆ¢„Å´Êèê‰æõ„Åô„ÇãÁã¨Ëá™„ÅÆ‰æ°ÂÄ§„ÇÑËß£Ê±∫Á≠ñ',
    examples: 'ÂìÅË≥™„ÄÅÂà©‰æøÊÄß„ÄÅ„Ç≥„Çπ„ÉàÂâäÊ∏õ„ÄÅÈù©Êñ∞ÊÄß„Å™„Å©'
  },
  'Customer Relationships': {
    japanese: 'È°ßÂÆ¢„Å®„ÅÆÈñ¢‰øÇ',
    description: 'È°ßÂÆ¢„Å®„ÅÆÈñ¢‰øÇ„ÇíÊßãÁØâ„ÉªÁ∂≠ÊåÅ„Åô„Çã„Åü„ÇÅ„ÅÆ‰ªïÁµÑ„Åø',
    examples: 'ÂÄã‰∫∫„Çµ„Éù„Éº„Éà„ÄÅ„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„ÄÅËá™ÂãïÂåñ„Çµ„Éº„Éì„Çπ„Å™„Å©'
  },
  'Channels': {
    japanese: '„ÉÅ„É£„Éç„É´',
    description: 'È°ßÂÆ¢„Å´‰æ°ÂÄ§„ÇíÂ±ä„Åë„Çã„Åü„ÇÅ„ÅÆÁµåË∑Ø',
    examples: 'Â∫óËàó„ÄÅ„Ç™„É≥„É©„Ç§„É≥„ÄÅ‰ª£ÁêÜÂ∫ó„ÄÅÁõ¥Ë≤©„Å™„Å©'
  },
  'Customer Segments': {
    japanese: 'È°ßÂÆ¢„Çª„Ç∞„É°„É≥„Éà',
    description: '„Çø„Éº„Ç≤„ÉÉ„Éà„Å®„Åô„ÇãÈ°ßÂÆ¢„ÅÆÁ®ÆÈ°û„ÇÑÂàÜÈ°û',
    examples: 'ÂÄã‰∫∫Ê∂àË≤ªËÄÖ„ÄÅ‰ºÅÊ•≠„ÄÅÁâπÂÆö„ÅÆÊ•≠Áïå„ÄÅÂπ¥ÈΩ¢Â±§„Å™„Å©'
  },
  'Cost Structure': {
    japanese: '„Ç≥„Çπ„ÉàÊßãÈÄ†',
    description: '„Éì„Ç∏„Éç„ÇπÈÅãÂñ∂„Å´ÂøÖË¶Å„Å™‰∏ªË¶Å„Ç≥„Çπ„Éà',
    examples: '‰∫∫‰ª∂Ë≤ª„ÄÅÂéüÊùêÊñôË≤ª„ÄÅË®≠ÂÇôË≤ª„ÄÅ„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞Ë≤ª„Å™„Å©'
  },
  'Revenue Streams': {
    japanese: 'ÂèéÁõä„ÅÆÊµÅ„Çå',
    description: 'ÂèéÁõä„ÇíÁîü„ÅøÂá∫„ÅôÊñπÊ≥ï„ÇÑ‰ªïÁµÑ„Åø',
    examples: 'ÂïÜÂìÅË≤©Â£≤„ÄÅ„Çµ„Éº„Éì„ÇπÊñô„ÄÅ„É©„Ç§„Çª„É≥„ÇπÊñô„ÄÅÂ∫ÉÂëäÂèéÂÖ•„Å™„Å©'
  }
};

// Ê•≠Á®ÆÂà•„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà
const INDUSTRY_COLORS = {
  "Ëá™ÂãïËªä„ÉªËº∏ÈÄÅÊ©üÂô®": {
    bg: "bg-blue-50",
    border: "border-blue-200",
    text: "text-blue-700",
    accent: "bg-blue-100",
    icon: "üöó"
  },
  "È£üÊñôÂìÅ": {
    bg: "bg-orange-50",
    border: "border-orange-200", 
    text: "text-orange-700",
    accent: "bg-orange-100",
    icon: "üçé"
  },
  "ÊÉÖÂ†±„ÉªÈÄö‰ø°Ê•≠": {
    bg: "bg-purple-50",
    border: "border-purple-200",
    text: "text-purple-700", 
    accent: "bg-purple-100",
    icon: "üì°"
  },
  "ÈõªÊ∞óÊ©üÂô®": {
    bg: "bg-green-50",
    border: "border-green-200",
    text: "text-green-700",
    accent: "bg-green-100", 
    icon: "‚ö°"
  },
  "ÈäÄË°åÊ•≠": {
    bg: "bg-gray-50",
    border: "border-gray-200",
    text: "text-gray-700",
    accent: "bg-gray-100",
    icon: "üè¶"
  },
  "Âç∏Â£≤Ê•≠": {
    bg: "bg-yellow-50", 
    border: "border-yellow-200",
    text: "text-yellow-700",
    accent: "bg-yellow-100",
    icon: "üì¶"
  },
  "Ë£ΩËñ¨": {
    bg: "bg-red-50",
    border: "border-red-200", 
    text: "text-red-700",
    accent: "bg-red-100",
    icon: "üíä"
  },
  "Â∞èÂ£≤Ê•≠": {
    bg: "bg-indigo-50",
    border: "border-indigo-200",
    text: "text-indigo-700",
    accent: "bg-indigo-100",
    icon: "üõí"
  },
  "Âª∫Ë®≠Ê•≠": {
    bg: "bg-amber-50",
    border: "border-amber-200",
    text: "text-amber-700",
    accent: "bg-amber-100",
    icon: "üèóÔ∏è"
  },
  "„Åù„ÅÆ‰ªñ": {
    bg: "bg-slate-50",
    border: "border-slate-200",
    text: "text-slate-700", 
    accent: "bg-slate-100",
    icon: "üè¢"
  }
};

// Ê•≠Á®Æ„Ç´„É©„Éº„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
const getIndustryColor = (industry) => {
  return INDUSTRY_COLORS[industry] || INDUSTRY_COLORS["„Åù„ÅÆ‰ªñ"];
};

// Ê§úÁ¥¢„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const SearchComponent = ({ companies, onCompanySelect }) => {
  const [query, setQuery] = useState('');
  const [isOpen, setIsOpen] = useState(false);
  const navigate = useNavigate();

  // „Ç∑„É≥„Éó„É´„Å™Ê§úÁ¥¢Ê©üËÉΩ
  const searchResults = useMemo(() => {
    if (!query.trim()) return [];
    
    const lowerQuery = query.toLowerCase();
    return companies.filter(company => 
      company.name.toLowerCase().includes(lowerQuery) ||
      company.code.includes(query) ||
      company.name_kana.includes(lowerQuery) ||
      company.name_en.toLowerCase().includes(lowerQuery) ||
      (company.industry && company.industry.toLowerCase().includes(lowerQuery))
    ).slice(0, 5);
  }, [companies, query]);

  const handleSelect = (company) => {
    setQuery('');
    setIsOpen(false);
    if (onCompanySelect) onCompanySelect(company);
    navigate(`/company/${company.code}`);
  };

  return (
    <div className="relative w-full max-w-md mx-auto">
      <div className="relative">
        <Search className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
        <input
          type="text"
          placeholder="‰ºÅÊ•≠Âêç„ÉªË®ºÂà∏„Ç≥„Éº„Éâ„ÉªÊ•≠Á®Æ„ÅßÊ§úÁ¥¢..."
          className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          value={query}
          onChange={(e) => {
            setQuery(e.target.value);
            setIsOpen(true);
          }}
          onFocus={() => setIsOpen(true)}
          onBlur={() => setTimeout(() => setIsOpen(false), 200)}
        />
      </div>
      
      {isOpen && query && searchResults.length > 0 && (
        <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
          {searchResults.map((company) => {
            const colors = company.industry ? getIndustryColor(company.industry) : getIndustryColor("„Åù„ÅÆ‰ªñ");
            return (
              <button
                key={company.code}
                className="w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0"
                onClick={() => handleSelect(company)}
              >
                <div className="flex items-center justify-between">
                  <div className="flex-1">
                    <div className="font-medium text-gray-900">{company.name}</div>
                    <div className="text-sm text-gray-500">
                      {company.code} | {company.name_en}
                    </div>
                  </div>
                  <div className="flex items-center space-x-2">
                    {company.industry && (
                      <span className={`text-xs px-2 py-1 rounded-full ${colors.accent} ${colors.text}`}>
                        {company.industry}
                      </span>
                    )}
                    <span className="text-lg">{colors.icon}</span>
                  </div>
                </div>
              </button>
            );
          })}
        </div>
      )}
    </div>
  );
};

// Ê•≠Á®Æ„Éï„Ç£„É´„Çø„Éº„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const IndustryFilter = ({ companies, selectedIndustry, onIndustryChange }) => {
  const industries = [...new Set(companies.map(c => c.industry).filter(Boolean))].sort();
  
  if (industries.length === 0) return null;
  
  return (
    <div className="mb-6 bg-white rounded-lg shadow-sm border p-4">
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-sm font-semibold text-gray-700">Ê•≠Á®Æ„ÅßÁµû„ÇäËæº„Åø</h3>
        {selectedIndustry && (
          <button
            onClick={() => onIndustryChange(null)}
            className="text-xs text-blue-600 hover:text-blue-800 underline flex items-center space-x-1"
          >
            <ArrowLeft className="h-3 w-3" />
            <span>„Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢</span>
          </button>
        )}
      </div>
      <div className="flex flex-wrap gap-2">
        <button
          onClick={() => onIndustryChange(null)}
          className={`px-3 py-1.5 rounded-full text-xs font-medium transition-colors ${
            selectedIndustry === null 
              ? 'bg-blue-100 text-blue-700 border border-blue-200' 
              : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
          }`}
        >
          „Åô„Åπ„Å¶ ({companies.length})
        </button>
        {industries.map(industry => {
          const count = companies.filter(c => c.industry === industry).length;
          const colors = getIndustryColor(industry);
          const isSelected = selectedIndustry === industry;
          return (
            <button
              key={industry}
              onClick={() => onIndustryChange(isSelected ? null : industry)}
              className={`px-3 py-1.5 rounded-full text-xs font-medium transition-colors flex items-center space-x-1 ${
                isSelected
                  ? `${colors.accent} ${colors.text} border ${colors.border} ring-2 ring-blue-200` 
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              <span>{colors.icon}</span>
              <span>{industry} ({count})</span>
              {isSelected && (
                <span className="ml-1 text-xs">‚úï</span>
              )}
            </button>
          );
        })}
      </div>
      {selectedIndustry && (
        <div className="mt-3 p-2 bg-blue-50 rounded text-xs text-blue-700">
          <span className="font-medium">{getIndustryColor(selectedIndustry).icon} {selectedIndustry}</span> „ÅÆ‰ºÅÊ•≠„ÅÆ„ÅøË°®Á§∫‰∏≠
        </div>
      )}
    </div>
  );
};

// Ê•≠Á®ÆÂà•‰ºÅÊ•≠„Ç´„Éº„Éâ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const CompanyCard = ({ company }) => {
  const colors = company.industry ? getIndustryColor(company.industry) : getIndustryColor("„Åù„ÅÆ‰ªñ");
  
  return (
    <Link
      to={`/company/${company.code}`}
      className={`p-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 border text-left block transform hover:-translate-y-1 ${colors.bg} ${colors.border}`}
    >
      <div className="flex items-start justify-between mb-2">
        <div className="font-semibold text-gray-900 flex-1">
          {company.name}
        </div>
        <span className="text-lg ml-2 flex-shrink-0">
          {colors.icon}
        </span>
      </div>
      
      <div className="space-y-1">
        <div className="text-sm text-gray-500">
          {company.code}
        </div>
        {company.industry && (
          <div className={`text-xs font-medium px-2 py-1 rounded-full inline-block ${colors.accent} ${colors.text}`}>
            {company.industry}
          </div>
        )}
        <div className="text-xs text-gray-400 mt-1">
          {company.name_en}
        </div>
      </div>
    </Link>
  );
};

// „Ç∑„É≥„Éó„É´„Å™BMC„Éñ„É≠„ÉÉ„ÇØ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const SimpleBMCBlock = ({ title, content, className = "", colorScheme = "default" }) => {
  const translation = BMC_TRANSLATIONS[title];
  const htmlContent = parseMarkdown(content);

  const colorClasses = {
    default: "bg-white border-gray-200",
    yellow: "bg-yellow-50 border-yellow-200 border-2",
    red: "bg-red-50 border-red-200",
    green: "bg-green-50 border-green-200"
  };

  return (
    <div className={`rounded-lg shadow-md border flex flex-col ${colorClasses[colorScheme]} ${className}`}>
      {/* „Çø„Ç§„Éà„É´ÈÉ®ÂàÜ */}
      <div className="p-6 pb-4">
        <h3 className="text-xl font-semibold text-gray-800 mb-2">
          {title}
        </h3>
        {translation && (
          <div className="text-sm text-blue-600 font-medium mb-1">
            {translation.japanese}
          </div>
        )}
        {translation && (
          <div className="text-xs text-gray-500 mb-4">
            {translation.description}
          </div>
        )}
        
        {/* ‰æã„ÅÆË°®Á§∫ */}
        {translation && (
          <div className="text-xs text-gray-600 mb-4 p-3 bg-blue-50 rounded border border-blue-100">
            <span className="font-medium">‰æã:</span> {translation.examples}
          </div>
        )}
      </div>
      
      {/* „Ç≥„É≥„ÉÜ„É≥„ÉÑÈÉ®ÂàÜ */}
      <div className="px-6 pb-6 flex-grow">
        <div 
          className="text-sm text-gray-700 leading-relaxed"
          dangerouslySetInnerHTML={{ __html: htmlContent }}
        />
      </div>
    </div>
  );
};

// Âõ∫ÂÆöÂπÖ„Çπ„ÇØ„É≠„Éº„É´ÂØæÂøú„ÅÆBMCË°®Á§∫„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const BMCCanvas = ({ bmcData }) => {
  const { sections } = bmcData;
  const [showZoomHint, setShowZoomHint] = useState(true);
  const [isMobile, setIsMobile] = useState(false);
  const [topRowHeight, setTopRowHeight] = useState(420); // ÂàùÊúüÂÄ§
  const topRowRef = useRef(null);
  const containerRef = useRef(null);
  const [zoom, setZoom] = useState(1);
  const [showZoomControls, setShowZoomControls] = useState(false);



  // „É¢„Éê„Ç§„É´Âà§ÂÆö
  useEffect(() => {
    const checkMobile = () => {
      const isMobileDevice = window.innerWidth < 768;
      setIsMobile(isMobileDevice);
      setShowZoomControls(isMobileDevice); // „É¢„Éê„Ç§„É´„ÅÆÂ†¥Âêà„ÅÆ„Åø„Ç≥„É≥„Éà„É≠„Éº„É´Ë°®Á§∫
    };
    
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);


  // „Ç∫„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
  const ZoomControls = () => {
    if (!showZoomControls) return null;
    
    return (
      <div className="fixed bottom-20 right-4 flex flex-col space-y-2 z-50 bg-white rounded-lg shadow-lg p-2">
        <button 
          onClick={() => setZoom(prev => Math.min(prev + 0.3, 3))}
          className="bg-blue-600 text-white p-3 rounded-full shadow-md hover:bg-blue-700 transition-colors"
          aria-label="Êã°Â§ß"
        >
          <span className="text-lg font-bold">+</span>
        </button>
        <button 
          onClick={() => setZoom(prev => Math.max(prev - 0.3, 0.5))}
          className="bg-blue-600 text-white p-3 rounded-full shadow-md hover:bg-blue-700 transition-colors"
          aria-label="Á∏ÆÂ∞è"
        >
          <span className="text-lg font-bold">‚àí</span>
        </button>
        <button 
          onClick={() => setZoom(1)}
          className="bg-gray-600 text-white p-2 rounded-full shadow-md hover:bg-gray-700 transition-colors text-xs"
          aria-label="„É™„Çª„ÉÉ„Éà"
        >
          1:1
        </button>
        <div className="text-xs text-center text-gray-600 bg-white rounded px-2 py-1">
          {Math.round(zoom * 100)}%
        </div>
      </div>
    );
  };

  // ‰∏äÈÉ®Ë°å„ÅÆÈ´ò„Åï„ÇíÊ∏¨ÂÆö„Åó„Å¶‰∏ãÈÉ®„Éñ„É≠„ÉÉ„ÇØ„ÅÆ‰ΩçÁΩÆ„ÇíË™øÊï¥
  const measureTopRowHeight = useCallback(() => {
    if (topRowRef.current) {
      const rect = topRowRef.current.getBoundingClientRect();
      const newHeight = Math.max(420, rect.height); // ÊúÄÂ∞è420px
      setTopRowHeight(newHeight);
      
      // „Ç≥„É≥„ÉÜ„ÉäÂÖ®‰Ωì„ÅÆÈ´ò„Åï„ÇÇË™øÊï¥
      if (containerRef.current) {
        const totalHeight = newHeight + 240 + 48 + 24; // ‰∏äÈÉ® + ‰∏ãÈÉ® + ÈñìÈöî + „Éë„Éá„Ç£„É≥„Ç∞
        containerRef.current.style.minHeight = `${totalHeight}px`;
      }
    }
  }, []);

  // ResizeObserver„Åß‰∏äÈÉ®„Éñ„É≠„ÉÉ„ÇØ„ÅÆÈ´ò„ÅïÂ§âÂåñ„ÇíÁõ£Ë¶ñ
  useEffect(() => {
    const resizeObserver = new ResizeObserver(() => {
      setTimeout(measureTopRowHeight, 100); // Â∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶Á¢∫ÂÆü„Å´Ê∏¨ÂÆö
    });

    if (topRowRef.current) {
      resizeObserver.observe(topRowRef.current);
    }

    // ÂàùÂõûÊ∏¨ÂÆö
    setTimeout(measureTopRowHeight, 200);

    return () => {
      resizeObserver.disconnect();
    };
  }, [measureTopRowHeight, sections]);

  // „Éí„É≥„ÉàÈùûË°®Á§∫„Çø„Ç§„Éû„Éº
  useEffect(() => {
    if (isMobile && showZoomHint) {
      const timer = setTimeout(() => {
        setShowZoomHint(false);
      }, 5000);
      
      return () => clearTimeout(timer);
    }
  }, [isMobile, showZoomHint]);

  // „Ç∫„Éº„É†„Éí„É≥„Éà„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
  const ZoomHint = () => {
    if (!isMobile || !showZoomHint) return null;

    return (
      <div className="fixed top-20 left-4 right-4 bg-blue-600 text-white p-3 rounded-lg shadow-lg z-50 animate-bounce">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-2">
            <span className="text-2xl">üëÜ</span>
            <div>
              <div className="font-semibold text-sm">„Éî„É≥„ÉÅ„Åß„Ç∫„Éº„É†„Éª„Éâ„É©„ÉÉ„Ç∞„Åß„Çπ„ÇØ„É≠„Éº„É´</div>
              <div className="text-xs opacity-90">BMCÂÖ®‰Ωì„ÇíËá™Áî±„Å´Êã°Â§ßÁ∏ÆÂ∞è„Åó„Å¶Á¢∫Ë™ç„Åß„Åç„Åæ„Åô</div>
            </div>
          </div>
          <button 
            onClick={() => setShowZoomHint(false)}
            className="text-white hover:text-gray-200 text-xl"
          >
            √ó
          </button>
        </div>
      </div>
    );
  };

  // BMC„ÅÆÂü∫Êú¨ÊÉÖÂ†±Ë°®Á§∫Ôºà„Çπ„Éû„ÉõÁî®Ôºâ
  const BMCOverview = () => {
    if (!isMobile) return null;

    return (
      <div className="mb-4 bg-white rounded-lg shadow-sm border p-4">
        <h3 className="font-semibold text-gray-800 mb-2">üìä „Éì„Ç∏„Éç„Çπ„É¢„Éá„É´„Ç≠„É£„É≥„Éê„Çπ</h3>
        <div className="text-sm text-gray-600 space-y-1">
          <div>‚Ä¢ ÈªÑËâ≤Ôºö<span className="font-medium">‰æ°ÂÄ§ÊèêÊ°à</span>Ôºà‰∏≠Â§Æ„ÅÆÈáçË¶Å„Å™ÈÉ®ÂàÜÔºâ</div>
          <div>‚Ä¢ Ëµ§Ëâ≤Ôºö<span className="font-medium">„Ç≥„Çπ„ÉàÊßãÈÄ†</span>Ôºà‰∏ãÈÉ®Â∑¶Ôºâ</div>
          <div>‚Ä¢ Á∑ëËâ≤Ôºö<span className="font-medium">ÂèéÁõä„ÅÆÊµÅ„Çå</span>Ôºà‰∏ãÈÉ®Âè≥Ôºâ</div>
          <div className="text-xs text-gray-500 mt-2">
            üí° „Éî„É≥„ÉÅ„Ç∫„Éº„É†„ÅßÊã°Â§ß„Åó„Å¶ÂêÑ„Éñ„É≠„ÉÉ„ÇØ„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô
          </div>
        </div>
      </div>
    );
  };

  return (
    <div>
      <ZoomHint />
      <BMCOverview />
      <ZoomControls />
      
      {/* Âõ∫ÂÆöÂπÖBMCË°®Á§∫„Ç®„É™„Ç¢ */}
      <div className="w-full overflow-auto bg-gray-100 rounded-lg border-2 border-gray-300" 
           style={{ 
             height: isMobile ? '70vh' : 'auto',
             WebkitOverflowScrolling: 'touch',
             touchAction: 'pan-x pan-y pinch-zoom',
             overscrollBehavior: 'contain'
           }}>
        
        {/* ÂãïÁöÑ„Çµ„Ç§„Ç∫„ÅÆBMC„Ç≥„É≥„ÉÜ„Éä */}
        <div 
          ref={containerRef}
          className="relative bg-white" 
          style={{ 
            width: '1400px', 
            minHeight: '900px', 
            padding: '24px',
            transform: `scale(${zoom})`,
            transformOrigin: 'top left',
            transition: 'transform 0.2s ease-out'
          }}
        >
          
          {/* BMC‰∏äÈÉ®„Ç∞„É™„ÉÉ„Éâ */}
          <div 
            ref={topRowRef}
            className="grid grid-cols-5 gap-6 mb-6" 
            style={{ minHeight: '420px' }}
          >
            
            {/* Key Partners */}
            <div className="col-span-1">
              <SimpleBMCBlock
                title="Key Partners"
                content={sections["Key Partners"]}
                className="h-full"
                colorScheme="default"
              />
            </div>
            
            {/* Key Activities & Key Resources */}
            <div className="col-span-1 flex flex-col gap-6">
              <div className="flex-1">
                <SimpleBMCBlock
                  title="Key Activities"
                  content={sections["Key Activities"]}
                  className="h-full"
                  colorScheme="default"
                />
              </div>
              <div className="flex-1">
                <SimpleBMCBlock
                  title="Key Resources"
                  content={sections["Key Resources"]}
                  className="h-full"
                  colorScheme="default"
                />
              </div>
            </div>
            
            {/* Value PropositionsÔºà‰∏≠Â§Æ„ÉªÂº∑Ë™øÔºâ */}
            <div className="col-span-1">
              <SimpleBMCBlock
                title="Value Propositions"
                content={sections["Value Propositions"]}
                className="h-full"
                colorScheme="yellow"
              />
            </div>
            
            {/* Customer Relationships & Channels */}
            <div className="col-span-1 flex flex-col gap-6">
              <div className="flex-1">
                <SimpleBMCBlock
                  title="Customer Relationships"
                  content={sections["Customer Relationships"]}
                  className="h-full"
                  colorScheme="default"
                />
              </div>
              <div className="flex-1">
                <SimpleBMCBlock
                  title="Channels"
                  content={sections["Channels"]}
                  className="h-full"
                  colorScheme="default"
                />
              </div>
            </div>
            
            {/* Customer Segments */}
            <div className="col-span-1">
              <SimpleBMCBlock
                title="Customer Segments"
                content={sections["Customer Segments"]}
                className="h-full"
                colorScheme="default"
              />
            </div>
          </div>
          
          {/* BMC‰∏ãÈÉ®„Ç∞„É™„ÉÉ„ÉâÔºàÂãïÁöÑ‰ΩçÁΩÆÔºâ */}
          <div 
            className="grid grid-cols-2 gap-6" 
            style={{ 
              height: '240px'
            }}
          >
            <div className="col-span-1">
              <SimpleBMCBlock
                title="Cost Structure"
                content={sections["Cost Structure"]}
                className="h-full"
                colorScheme="red"
              />
            </div>
            <div className="col-span-1">
              <SimpleBMCBlock
                title="Revenue Streams"
                content={sections["Revenue Streams"]}
                className="h-full"
                colorScheme="green"
              />
            </div>
          </div>
          
          {/* BMC„Ç∞„É™„ÉÉ„Éâ„É©„Ç§„É≥ÔºàÂãïÁöÑ‰ΩçÁΩÆÔºâ */}
          <div className="absolute inset-0 pointer-events-none">
            {/* ÂûÇÁõ¥Á∑ö */}
            <div className="absolute left-1/5 top-6 w-px bg-gray-200 opacity-30" 
                 style={{ height: `${topRowHeight}px` }}></div>
            <div className="absolute left-2/5 top-6 w-px bg-gray-200 opacity-30" 
                 style={{ height: `${topRowHeight}px` }}></div>
            <div className="absolute left-3/5 top-6 w-px bg-gray-200 opacity-30" 
                 style={{ height: `${topRowHeight}px` }}></div>
            <div className="absolute left-4/5 top-6 w-px bg-gray-200 opacity-30" 
                 style={{ height: `${topRowHeight}px` }}></div>
            
            {/* Ê∞¥Âπ≥Á∑öÔºàÂãïÁöÑ‰ΩçÁΩÆÔºâ */}
            <div className="absolute left-6 right-6 h-px bg-gray-200 opacity-30" 
                 style={{ top: `${topRowHeight + 48}px` }}></div>
          </div>
          
          {/* BMC„Çø„Ç§„Éà„É´ÔºàÂè≥‰∏ã„Å´„Ç¶„Ç©„Éº„Çø„Éº„Éû„Éº„ÇØÈ¢®Ôºâ */}
          <div className="absolute bottom-6 right-6 text-gray-400 text-sm font-medium">
            Business Model Canvas
          </div>
        </div>
      </div>
      
      {/* Êìç‰Ωú„Ç¨„Ç§„Éâ */}
      <div className="mt-4 text-center">
        {isMobile ? (
          <div className="text-sm text-gray-600 space-y-1">
            <div>üì± <span className="font-medium">„Éî„É≥„ÉÅ„Ç∫„Éº„É†</span>„ÅßÊã°Â§ß„ÉªÁ∏ÆÂ∞è</div>
            <div>üëÜ <span className="font-medium">„Éâ„É©„ÉÉ„Ç∞</span>„Åß„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶ÂÖ®‰Ωì„ÇíÁ¢∫Ë™ç</div>
          </div>
        ) : (
          <div className="text-sm text-gray-600">
            üñ±Ô∏è <span className="font-medium">„Éû„Ç¶„Çπ„Éõ„Ç§„Éº„É´</span>„Åß„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶BMCÂÖ®‰Ωì„ÇíÁ¢∫Ë™ç
          </div>
        )}
      </div>
    </div>
  );
};

// „Éò„ÉÉ„ÉÄ„Éº„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const Header = () => {
  const navigate = useNavigate();
  const params = useParams();
  const isCompanyPage = params.code;

  return (
    <header className="bg-white shadow-sm border-b border-gray-200">
      <div className="max-w-6xl mx-auto px-4 py-4">
        <div className="flex items-center justify-between">
          <Link to="/" className="flex items-center space-x-3 hover:opacity-80 transition-opacity">
            <img 
              src="./bmc-favicon.svg" 
              alt="BMC Viewer" 
              className="h-8 w-8"
            />
            <h1 className="text-2xl font-bold text-gray-900">
              Business Model Canvas Viewer
            </h1>
          </Link>
          {isCompanyPage && (
            <button
              onClick={() => navigate('/')}
              className="flex items-center space-x-2 px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
            >
              <ArrowLeft className="h-4 w-4" />
              <span>Ê§úÁ¥¢„Å´Êàª„Çã</span>
            </button>
          )}
        </div>
      </div>
    </header>
  );
};

// Ê§úÁ¥¢„Éö„Éº„Ç∏„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const SearchPage = ({ companies }) => {
  const navigate = useNavigate();
  const [selectedIndustry, setSelectedIndustry] = useState(null);

  const handleCompanySelect = (company) => {
    navigate(`/company/${company.code}`);
  };

  // Ê•≠Á®Æ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åï„Çå„Åü‰ºÅÊ•≠„É™„Çπ„Éà
  const filteredCompanies = selectedIndustry 
    ? companies.filter(company => company.industry === selectedIndustry)
    : companies;

  // Ê•≠Á®ÆÂà•„Ç∞„É´„Éº„ÉóÂåñ
  const companiesByIndustry = filteredCompanies.reduce((acc, company) => {
    const industry = company.industry || "„Åù„ÅÆ‰ªñ";
    if (!acc[industry]) {
      acc[industry] = [];
    }
    acc[industry].push(company);
    return acc;
  }, {});

  if (companies.length === 0) {
    return (
      <div className="text-center py-12">
        <div className="text-gray-500 mb-4">
          ‰ºÅÊ•≠„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...
        </div>
      </div>
    );
  }

  return (
    <div className="text-center">
      <div className="mb-8">
        <h2 className="text-3xl font-bold text-gray-900 mb-4">
          ‰ºÅÊ•≠„ÇíÊ§úÁ¥¢„Åó„Å¶BMC„ÇíË°®Á§∫
        </h2>
        <p className="text-gray-600 mb-8">
          TOPIX Core30‰ºÅÊ•≠„ÅÆ„Éì„Ç∏„Éç„Çπ„É¢„Éá„É´„Ç≠„É£„É≥„Éê„Çπ„ÇíÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô
        </p>
      </div>
      
      <SearchComponent 
        companies={companies} 
        onCompanySelect={handleCompanySelect} 
      />
      
      {/* ‰ºÅÊ•≠‰∏ÄË¶ßË°®Á§∫ */}
      {selectedIndustry ? (
        // ÁâπÂÆöÊ•≠Á®Æ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
        <div className="space-y-6">
          <div className="text-left">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-xl font-semibold text-gray-800 flex items-center">
                <span className="mr-2">{getIndustryColor(selectedIndustry).icon}</span>
                {selectedIndustry} ({filteredCompanies.length}Á§æ)
              </h3>
              <button
                onClick={() => setSelectedIndustry(null)}
                className="flex items-center space-x-2 px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors border border-gray-200"
              >
                <ArrowLeft className="h-4 w-4" />
                <span>„Åô„Åπ„Å¶Ë°®Á§∫„Å´Êàª„Çã</span>
              </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              {filteredCompanies.map((company) => (
                <CompanyCard key={company.code} company={company} />
              ))}
            </div>
          </div>
        </div>
      ) : (
        // ÂÖ®Ê•≠Á®ÆË°®Á§∫ÔºàÊ•≠Á®ÆÂà•„Ç∞„É´„Éº„ÉóË°®Á§∫Ôºâ
        <div className="space-y-8">
          {Object.entries(companiesByIndustry)
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([industry, industryCompanies]) => {
              const colors = getIndustryColor(industry);
              return (
                <div key={industry} className="text-left">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-semibold text-gray-800 flex items-center">
                      <span className="mr-2">{colors.icon}</span>
                      {industry} ({industryCompanies.length}Á§æ)
                    </h3>
                    <button
                      onClick={() => setSelectedIndustry(industry)}
                      className={`text-xs px-3 py-1 rounded-full transition-colors ${colors.accent} ${colors.text} hover:${colors.bg}`}
                    >
                      „Åì„ÅÆÊ•≠Á®Æ„ÅÆ„ÅøË°®Á§∫
                    </button>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    {industryCompanies.map((company) => (
                      <CompanyCard key={company.code} company={company} />
                    ))}
                  </div>
                </div>
              );
            })}
        </div>
      )}
      
      {filteredCompanies.length === 0 && (
        <div className="text-center py-12">
          <div className="text-gray-500 mb-4">
            Ë©≤ÂΩì„Åô„Çã‰ºÅÊ•≠„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü
          </div>
          <button
            onClick={() => setSelectedIndustry(null)}
            className="text-blue-600 hover:text-blue-800 underline"
          >
            „Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà
          </button>
        </div>
      )}
    </div>
  );
};

// ‰ºÅÊ•≠Ë©≥Á¥∞„Éö„Éº„Ç∏„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const CompanyPage = ({ companies }) => {
  const { code } = useParams();
  const [bmcData, setBmcData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // ‰ºÅÊ•≠‰∏ÄË¶ß„Åã„ÇâË©≤ÂΩì‰ºÅÊ•≠„ÇíÊ§úÁ¥¢
  const company = companies.find(c => c.code === code);

  useEffect(() => {
    const loadCompanyData = async () => {
      setLoading(true);
      setError(null);
      
      try {
        const response = await fetch(`${import.meta.env.BASE_URL}companies/${code}.md`);
        if (!response.ok) {
          throw new Error('‰ºÅÊ•≠„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        }
        
        const content = await response.text();
        const { metadata, content: body } = parseFrontmatter(content);
        const sections = extractBMCSections(body);
        
        // ‰ºÅÊ•≠Âêç„ÅÆÂÑ™ÂÖàÈ†Ü‰Ωç: metadata.title > ‰ºÅÊ•≠‰∏ÄË¶ß„ÅÆÂêçÂâç > „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        const title = metadata.title || (company ? company.name : `‰ºÅÊ•≠„Ç≥„Éº„Éâ: ${code}`);
        
        setBmcData({
          title,
          code: metadata.code || code,
          company, // ‰ºÅÊ•≠ÊÉÖÂ†±„ÇÇ‰øùÂ≠ò
          sections
        });
      } catch (err) {
        console.error('Error loading company data:', err);
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    if (code) {
      loadCompanyData();
    }
  }, [code, company]);

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="text-center text-red-600 py-12">
        <div className="mb-2">‚ö†Ô∏è {error}</div>
        <Link
          to="/"
          className="text-blue-600 hover:text-blue-800 underline"
        >
          Ê§úÁ¥¢„Å´Êàª„Çã
        </Link>
      </div>
    );
  }

  if (!bmcData) {
    return (
      <div className="text-center text-gray-500 py-12">
        „Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì
      </div>
    );
  }

  return (
    <div>
      <div className="mb-6">
        <h2 className="text-3xl font-bold text-gray-900 mb-2">
          {bmcData.title}
        </h2>
        <div className="flex items-center space-x-4 text-gray-600">
          <span className="flex items-center space-x-1">
            <FileText className="h-4 w-4" />
            <span>Ë®ºÂà∏„Ç≥„Éº„Éâ: {bmcData.code}</span>
          </span>
          {bmcData.company && (
            <>
              <span className="text-sm">
                {bmcData.company.name_en}
              </span>
              {bmcData.company.industry && (
                <span className={`text-xs px-2 py-1 rounded-full ${getIndustryColor(bmcData.company.industry).accent} ${getIndustryColor(bmcData.company.industry).text}`}>
                  {getIndustryColor(bmcData.company.industry).icon} {bmcData.company.industry}
                </span>
              )}
            </>
          )}
        </div>
      </div>

      <BMCCanvas bmcData={bmcData} />
    </div>
  );
};

// „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥
const AppContent = () => {
  const [companies, setCompanies] = useState([]);
  const [error, setError] = useState(null);

  // ‰ºÅÊ•≠„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
  useEffect(() => {
    const loadCompanies = async () => {
      try {
        const response = await fetch('./companies.json');
        if (!response.ok) {
          throw new Error('‰ºÅÊ•≠„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
        const data = await response.json();
        setCompanies(data);
      } catch (err) {
        console.error('Error loading companies:', err);
        setError(err.message);
      }
    };

    loadCompanies();
  }, []);

  if (error && companies.length === 0) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-600 mb-4">‚ö†Ô∏è „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>
          <div className="text-gray-600">{error}</div>
          <div className="text-sm text-gray-500 mt-2">
            companies.json„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      <main className="max-w-6xl mx-auto px-4 py-8">
        <Routes>
          <Route path="/" element={<SearchPage companies={companies} />} />
          <Route path="/company/:code" element={<CompanyPage companies={companies} />} />
        </Routes>
      </main>
    </div>
  );
};

// „Ç¢„Éó„É™„ÅÆ„Ç®„É≥„Éà„É™„Éº„Éù„Ç§„É≥„Éà
const App = () => {
  return (
      <AppContent />
  );
};

export default App;